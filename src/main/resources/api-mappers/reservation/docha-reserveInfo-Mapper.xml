<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ohdocha.admin.mapper.DochaAdminReserveInfoMapper">

    <!-- 예약 리스트 -->
    <select id="selectReserveInfoList" parameterType="reserveInfoRequest" resultType="reserveInfoResponse">
        <![CDATA[
SELECT * FROM (
            SELECT   RM_IDX                                                       /* 회원순번 */
                  , RT_IDX                                                    /* 회원사 순번 */
                  , RT_P_IDX                                                    /* 부모 회원사 */
                  , RESERVE_TYPE_CODE
                  , CASE    WHEN RENT_MI >= 365*24*60 THEN 'Y'
                        WHEN RENT_MI >= 30*24*60 THEN 'M'
                        WHEN RENT_MI >= 24*60 THEN 'D'
                         ELSE 'T'
                    END AS YMD                                                 /* 기간구분 */
                   , LAND_CODE                                                   /* 지역구분 */
                   , RESERVE_CHANNEL                                             /* 예약채널구분 */
                  , RESERVE_DATE                                                 /* 예약일시 */
                  , RESERVE_STATUS_CODE                                          /* 예약상태 코드 */
                  , IFNULL(RESERVE_STATUS_CODE, 'RSV') AS RESERVE_STATUS_NAME    /* 예약상태 명 */
                  , USER_NAME                                                 /* 회원명 */
                  , USER_CONTACT1                                              /* 연락처 */
                  , MODEL_NAME                                                 /* 모델명 */
                  , MODEL_DETAIL_NAME                                           /* 모델상세명 */
                  , CAR_NUMBER                                                 /* 차량번호 */
                  , IFNULL(FUEL_CODE, 'CR') AS FUEL_NAME                   /* 연료명 */
                  , RENT_START_DAY                                              /* 대여일시 */
                  , RENT_END_DAY                                                 /* 반납일시 */
                  , PERIOD_DT                                                   /* 사용기간 */
                  , COMPANY_NAME                                                 /* 회원사명 */
                  , BRANCH_NAME                                                 /* 지점명 */
                  , DELIVERY_TYPE_NAME                                           /* 대여방법 */
                   , PAYMENT_TOTAL_AMOUNT                                           /* 총 금액 */
                  , PAYMENT_AMOUNT                                              /* 결제금액 */
            FROM   (
                     SELECT
                        A.RM_IDX /* 예약 순번 */
                        , C.RT_IDX /* 회원사 순번 */
                        , D.RT_P_IDX /* 부모 회원사 */
                        , RESERVE_TYPE_CODE AS RESERVE_TYPE_CODE /* 예약종류code */
                        , CASE WHEN IFNULL(A.RESERVE_STATUS_CODE, 'RS') = 'RS' AND NOW() > STR_TO_DATE(A.RENT_END_DAY || A.RENT_END_TIME, '%Y%m%d%H:%i:%s') THEN 'RW'
                              WHEN IFNULL(A.RESERVE_STATUS_CODE, 'RS') = 'RS' AND NOW() BETWEEN STR_TO_DATE(A.RENT_START_DAY || A.RENT_START_TIME, '%Y%m%d%H:%i:%s') AND STR_TO_DATE(A.RENT_END_DAY || A.RENT_END_TIME, '%Y-%m-%d %H:%i:%s') THEN 'RO'
                                ELSE IFNULL(A.RESERVE_STATUS_CODE, 'RS') END
                          AS RESERVE_STATUS_CODE /* 상태 */
                        , IFNULL(A.RESERVE_CHANNEL, 'CS') AS RESERVE_CHANNEL /* 예약 경로 [CA:카썸관리자, CS:웹,어플] */
                        , ROUND((STR_TO_DATE(A.RENT_END_DAY || A.RENT_END_TIME, '%Y%m%d%H:%i:%s') - STR_TO_DATE(A.RENT_START_DAY || A.RENT_START_TIME, '%Y%m%d%H:%i:%s'))*24*60) AS RENT_MI /* 총 예약 시간(분) */
                        , DATE_FORMAT(A.RESERVE_DATE, '%Y-%m-%d %H:%i:%s') AS RESERVE_DATE /* 예약일 */
                        , IFNULL(A.RESERVE_USER_NAME, '') AS USER_NAME /* 예약자명 */
                        , IFNULL(A.RESERVE_USER_CONTACT1, '') AS USER_CONTACT1 /* 예약자 전화번호 */
                        , IFNULL(C.MODEL_NAME, '') AS MODEL_NAME /* 차종명 */
                        , IFNULL(C.MODEL_DETAIL_NAME, '') AS MODEL_DETAIL_NAME /* 차종상세명 */
                        , IFNULL(C.CAR_NUMBER, '') AS CAR_NUMBER /* 차량번호 */
                        , IFNULL(C.FUEL_CODE, '') AS FUEL_CODE /* 연료코드 */
                        , DATE_FORMAT(STR_TO_DATE(CONCAT(RENT_START_DAY,' ', RENT_START_TIME), '%Y%m%d %H%i%s'), '%Y%m%d %H%i%s') AS RENT_START_DAY /* 대여 시작 일시 */
                        , DATE_FORMAT(STR_TO_DATE(CONCAT(RENT_END_DAY,' ', RENT_END_TIME), '%Y%m%d %H%i%s'), '%Y%m%d %H%i%s') AS RENT_END_DAY /* 대여 종료 일시 */
                        , IFNULL(A.PERIOD_DT, '') AS  PERIOD_DT /* 대여기간 */
                        , IFNULL(D.COMPANY_NAME , '') AS COMPANY_NAME /* 회원사명 */
                        , IFNULL(D.BRANCH_NAME, '') AS BRANCH_NAME /* 지점명 */
                        , IFNULL(A.DELIVERY_TYPE_CODE, '') AS DELIVERY_TYPE_CODE /* 대여방법 코드 */
                        , IFNULL(A.DELIVERY_TYPE_CODE, '') AS DELIVERY_TYPE_NAME /* 대여 방법 명 */
                          , PAYMENT_TOTAL_AMOUNT as PAYMENT_TOTAL_AMOUNT
                        , (SELECT SUM(IFNULL(PAYMENT_AMOUNT, '0')) FROM DC_PAYMENT_DETAIL WHERE RM_IDX = A.RM_IDX) AS PAYMENT_AMOUNT /* 총 결제금액 */
                        , CASE WHEN INSTR(D.COMPANY_AddRESS||D.COMPANY_AddRESS_DETAIL, '제주') > 0 THEN 'JJ' ELSE 'IL' END AS LAND_CODE /* 내륙/제주 구분 [JJ:제주,IL:내륙,IS:제주 제외한 섬] */
                     FROM DC_RESERVE_MASTER A INNER JOIN DC_CAR_INFO C ON A.CR_IDX = C.CR_IDX
                                         INNER JOIN DC_RENT_COMPANY D ON A.RT_IDX = D.RT_IDX
                  ) X
                 ORDER BY RESERVE_DATE DESC) Y
            ]]>
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="gbnDay != null and gbnDay != ''">
                AND YMD = #{gbnDay}
            </if>
            <if test="gbnLocation != null and gbnLocation != ''">
                AND LAND_CODE = #{gbnLocation}
            </if>
            <if test="gbnReserve != null and gbnReserve != ''">
                AND RESERVE_TYPE_CODE = #{gbnReserve}
            </if>
            <if test="gbnStatus != null and gbnStatus != ''">
                AND RESERVE_STATUS_CODE = #{gbnStatus}
            </if>
            <if test="gbnInput != null and gbnInput != ''">
                <choose>
                    <when test ="gbnInput == 'CT' and searchKeyWord != null and searchKeyWord != '' " >
                        AND USER_CONTACT1 LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <when test ="gbnInput == 'MD' and searchKeyWord != null and searchKeyWord != ''  " >
                        AND (MODEL_NAME || ' ' || MODEL_DETAIL_NAME) LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <when test ="gbnInput == 'CM' and searchKeyWord != null and searchKeyWord != ''  " >
                        AND COMPANY_NAME LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <when test ="gbnInput == 'DL' and searchKeyWord != null and searchKeyWord != ''  " >
                        AND DELIVERY_TYPE_NAME LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <when test ="gbnInput == 'RM' and searchKeyWord != null and searchKeyWord != ''  " >
                        AND RM_IDX LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <when test ="gbnInput == 'CR' and searchKeyWord != null and searchKeyWord != ''  " >
                        AND CAR_NUMBER LIKE '%' || #{searchKeyWord} || '%'
                    </when>
                    <otherwise>
                    </otherwise>
                </choose>
            </if>
            <if test="rtIdx != null and rtIdx != '' ">
                AND RT_IDX = #{rtIdx}
            </if>
            <if test="rtPIdx != null and rtPIdx != '' ">
                AND RT_P_IDX = #{rtPIdx}
            </if>
        </trim>
    </select>

    <!-- 예약 상세 -->
    <select id="selectReserveInfo" parameterType="reserveInfoRequest" resultType="reserveInfoDetailResponse">
      <![CDATA[
              SELECT
              A.RM_IDX /* 예약순번 */
              , A.UR_IDX /* 예약자 순번 */
              , A.RESERVE_USER_NAME /* 예약자명 */
              , IFNULL(A.RESERVE_USER_GENDER, B.USER_GENDER) AS RESERVE_USER_GENDER /* 예약자 성별 */
              , IFNULL(A.RESERVE_USER_EMAIL, B.USER_ID) AS RESERVE_USER_EMAIL /* 예약자 이메일 [회원:ID, 비회원:EMAIL] */
              , IFNULL(A.RESERVE_USER_CONTACT1, B.USER_CONTACT1) AS RESERVE_USER_CONTACT1 /* 예약자 전화번호 */
              , IFNULL(A.RESERVE_USER_BIRTHDAY, B.USER_BIRTHDAY) AS RESERVE_USER_BIRTHDAY /* 예약자 생년월일 */
              , CASE WHEN IFNULL(A.UL_IDX1, '') = '' THEN '비회원' ELSE '회원' END AS USER_FLAG /* 회원/비회원 예약 구분 */
              , IFNULL(A.UL_IDX1, '') AS UL_IDX1 /* 제1운전자 회원순번 */
              , IFNULL(A.FIRST_DRIVER_NAME, '') AS FIRST_DRIVER_NAME /* 제1운전자 명 */
              , IFNULL(A.FIRST_DRIVER_GENDER, '') AS FIRST_DRIVER_GENDER /* 제1운전자 성별 */
              , IFNULL(A.FIRST_DRIVER_CONTACT, '') AS FIRST_DRIVER_CONTACT /* 제1운전자 전화번호 */
              , IFNULL(A.FIRST_DRIVER_BIRTHDAY, '') AS FIRST_DRIVER_BIRTHDAY /* 제1운전자 생년월일 */
              , IFNULL(A.FIRST_DRIVER_LICENSE_CODE, '') AS FIRST_DRIVER_LICENSE_CODE /* 제1운전자 면허종류 */
              , IFNULL(A.FIRST_DRIVER_LICENSE_NUMBER, '') AS FIRST_DRIVER_LICENSE_NUMBER /* 제1운전자 면허번호 */
              , IFNULL(A.FIRST_DRIVER_EXPIRATION_DATE, '') AS FIRST_DRIVER_EXPIRATION_DATE /* 제1운전자 만료일 */
              , IFNULL(A.FIRST_DRIVER_LICENSE_IS_DATE, '') AS FIRST_DRIVER_LICENSE_IS_DATE /* 제1운전자 발급일 */
              , IFNULL(A.UL_IDX2, '') AS UL_IDX2 /* 제2운전자 회원순번 */
              , IFNULL(A.SECOND_DRIVER_NAME, '') AS SECOND_DRIVER_NAME /* 제2운전자 명 */
              , IFNULL(A.SECOND_DRIVER_GENDER, '') AS SECOND_DRIVER_GENDER /* 제2운전자 성별 */
              , IFNULL(A.SECOND_DRIVER_CONTACT, '') AS SECOND_DRIVER_CONTACT /* 제2운전자 전화번호 */
              , IFNULL(A.SECOND_DRIVER_BIRTHDAY, '') AS SECOND_DRIVER_BIRTHDAY/* 제2운전자 생년월일 */
              , IFNULL(A.SECOND_DRIVER_LICENSE_CODE, '') AS SECOND_DRIVER_LICENSE_CODE /* 제2운전자 면허종류 */
              , IFNULL(A.SECOND_DRIVER_LICENSE_NUMBER, '') AS SECOND_DRIVER_LICENSE_NUMBER /* 제2운전자 면허번호 */
              , IFNULL(A.SECOND_DRIVER_EXPIRATION_DATE, '') AS SECOND_DRIVER_EXPIRATION_DATE /* 제2운전자 만료일 */
              , IFNULL(A.SECOND_DRIVER_LICENSE_IS_DATE, '') AS SECOND_DRIVER_LICENSE_IS_DATE /* 제2운전자 발급일 */

              , CASE WHEN ROUND((STR_TO_DATE(CONCAT(A.RENT_END_DAY ,' ', A.RENT_END_TIME), '%Y-%m-%d %H:%i:%s') - STR_TO_DATE(CONCAT(A.RENT_START_DAY ,' ', A.RENT_START_TIME), '%Y-%m-%d %H:%i:%s'))*24*60) >= 365*24*60 THEN 'Y'
                     WHEN ROUND((STR_TO_DATE(CONCAT(A.RENT_END_DAY ,' ', A.RENT_END_TIME), '%Y-%m-%d %H:%i:%s') - STR_TO_DATE(CONCAT(A.RENT_START_DAY ,' ', A.RENT_START_TIME), '%Y-%m-%d %H:%i:%s'))*24*60) >= 30*24*60 THEN 'M'
                     WHEN ROUND((STR_TO_DATE(CONCAT(A.RENT_END_DAY ,' ', A.RENT_END_TIME), '%Y-%m-%d %H:%i:%s') - STR_TO_DATE(CONCAT(A.RENT_START_DAY ,' ', A.RENT_START_TIME), '%Y-%m-%d %H:%i:%s'))*24*60) >= 24*60 THEN 'D'
                ELSE 'T' END AS RESERVE_YMDT /* 시간구분 */
              , IFNULL(A.RESERVE_CHANNEL, 'CS') AS RESERVE_CHANNEL /* 저장 채널 구분 */
              , CASE WHEN INSTR(D.COMPANY_ADDRESS||D.COMPANY_ADDRESS_DETAIL, '제주') > 0 THEN 'JJ' ELSE 'IL' END AS LAND_CODE /* 내륙/제주 구분 [JJ:제주,IL:내륙,IS:제주 제외한 섬] */
              , DATE_FORMAT(A.RESERVE_DATE, '%Y-%m-%d %H:%i:%s:SS') AS RESERVE_DATE /* 예약일시 */
              , CASE WHEN IFNULL(A.RESERVE_STATUS_CODE, 'RS') = 'RS' AND NOW() > STR_TO_DATE(CONCAT(A.RENT_END_DAY ,' ', A.RENT_END_TIME), '%Y-%m-%d %H:%i:%s') THEN 'RW'
                     WHEN IFNULL(A.RESERVE_STATUS_CODE, 'RS') = 'RS' AND NOW() BETWEEN STR_TO_DATE(CONCAT(A.RENT_START_DAY ,' ', A.RENT_START_TIME), '%Y-%m-%d %H:%i:%s') AND STR_TO_DATE(CONCAT(A.RENT_END_DAY ,' ', A.RENT_END_TIME), '%Y-%m-%d %H:%i:%s') THEN 'RO'
                ELSE IFNULL(A.RESERVE_STATUS_CODE, 'RS') END AS RESERVE_STATUS_CODE /* 예약상태 */
              , IFNULL(A.RESERVE_TYPE_CODE, '') AS RESERVE_TYPE_CODE /*예약종류code*/
              , IFNULL(A.DELIVERY_TYPE_CODE, '') AS DELIVERY_TYPE_CODE /* 배달방법 */
              , STR_TO_DATE(CONCAT(RENT_START_DAY,' ', RENT_START_TIME), '%Y%m%d %H%i')  AS RENT_START_DAY /* 대여 시작 일시 */
              , STR_TO_DATE(CONCAT(RENT_END_DAY,' ', RENT_END_TIME), '%Y%m%d %H%i')  AS RENT_END_DAY /* 대여 종료 일시 */
              , IFNULL(A.PERIOD_DT, '') AS PERIOD_DT /* 사용기간 */
              , IFNULL(A.DELIVERY_ADDR, '') AS DELIVERY_ADDR /* 대여위치 */
              , IFNULL(A.RETURN_ADDR, '') AS RETURN_ADDR /* 반납위치 */

              , A.RT_IDX /* 회원사 순번*/
              , E.STAFF_NAME /* 관리자명 */
              , IFNULL(E.STAFF_CONTACT1, D.COMPANY_CONTACT1) AS STAFF_CONTACT1 /* 관리자 전화번호 */
              , A.CR_IDX /* 차량 순번 */
              , C.MD_IDX /* 차량 순번 */
              , IFNULL(C.ONSELF_DAMAGE_COVER, '0') AS ONSELF_DAMAGE_COVER /* 자손보상금액 */
              , IFNULL(C.PERSONAL_COVER, '0') AS PERSONAL_COVER /* 대인보상금액 */
              , IFNULL(C.PROPERTY_DAMAGE_COVER, '0') AS PROPERTY_DAMAGE_COVER   /* 대물보상금액 */
              , IFNULL(A.CAR_DAMAGE_COVER, '') AS CAR_DAMAGE_COVER /* 예약시 자차보상금(면책금)*/
              , IFNULL(A.INSURANCE_COPAYMENT, '') AS INSURANCE_COPAYMENT /* 예약시 고객부담금(보험료)*/
              , IFNULL(C.FUEL_CODE, '') AS FUEL_CODE /* 연료코드 */

              , IFNULL(A.RENT_FEE, '0') AS RENT_FEE /* 대여금 */
              , IFNULL(A.INSURANCE_FEE, '0') AS INSURANCE_FEE /* 보험료 */
              , IFNULL(A.DISCOUNT_FEE, '0') AS DISCOUNT_FEE /* 할인금액 */
              , IFNULL(A.DELIVERY_FEE, '0') AS DELIVERY_FEE /* 왕복배달금액 */
              , IFNULL(A.ADD_FEE, '0') AS ADD_FEE /* 추가수수료 */
              , IFNULL(A.PAYMENT_TOTAL_AMOUNT, '0') AS PAYMENT_TOTAL_AMOUNT /* 총 대여금액 */
              , CASE WHEN LONGTERM_YN = 'LT' THEN C.MONTHLY_STANDARD_PAY ELSE IFNULL(A.PAYMENT_TOTAL_AMOUNT, '0') END AS PAYMENT_AMOUNT /* 결제금액 */
              , IFNULL(A.REFUND_FEE, '0') AS REFUND_FEE /* 환불금액 */
              , IFNULL(A.PAYMENT_TOTAL_AMOUNT, '0') - (SELECT SUM(PAYMENT_AMOUNT) FROM DC_PAYMENT_DETAIL WHERE RM_IDX = A.RM_IDX) AS MISU /* 미납금 */
              FROM DC_RESERVE_MASTER A LEFT JOIN DC_USER_INFO B ON A.UR_IDX = B.UR_IDX
                                        INNER JOIN DC_CAR_INFO C ON A.CR_IDX = C.CR_IDX
                                        INNER JOIN DC_RENT_COMPANY D ON A.RT_IDX = D.RT_IDX
                                        LEFT JOIN DC_RENT_COMPANY_STAFF E ON A.RT_IDX = E.RT_IDX AND E.OWNER_YN = 'Y'
              WHERE A.RM_IDX = #{rmIdx}
        ]]>

   </select>

    <!-- 결제 리스트 (수납정보) -->
    <select id="selectPaymentList" parameterType="reserveInfoRequest" resultType="reserveInfoDetailResponse">

      <![CDATA[

                 SELECT T1.PD_IDX
                 ,      IFNULL(T1.RM_IDX              , '' ) AS RM_IDX
                 ,      IFNULL(T1.PG_CODE             , '' ) AS PG_CODE
                 ,      IFNULL(T1.PAYMENT_TYPE_CODE   , '' ) AS PAYMENT_TYPE_CODE
--                  ,      GET_COMMON_CODE_VALUE('PAY', IFNULL(T1.PAYMENT_TYPE_CODE   , '' )) as PAYMENT_TYPE_NAME
                 ,      IFNULL(T1.PAYMENT_KIND_CODE   , '' ) AS PAYMENT_KIND_CODE
--                  ,      GET_COMMON_CODE_VALUE('PAY', IFNULL(T1.PAYMENT_KIND_CODE   , '' )) as PAYMENT_KIND_NAME
                 ,      IFNULL(T1.PAYMENT_AMOUNT      , '' ) AS PAYMENT_AMOUNT
                 ,      IFNULL(T1.APPROVAL_NUMBER     , '' ) AS APPROVAL_NUMBER
                 ,      IFNULL(T1.PAYMENT_DATE        , '' ) AS PAYMENT_DATE
                 ,      IFNULL(T1.ETC                 , '' ) AS ETC
                 ,      IFNULL(T1.UR_IDX              , '' ) AS UR_IDX
                 FROM   DC_PAYMENT_DETAIL T1
                 WHERE  T1.RM_IDX = #{rmIdx}
                 AND IFNULL(T1.PAYMENT_AMOUNT, '0' ) > 0

        ]]>

   </select>


    <update id="updateReserveInfo" parameterType="reserveInfoDetailRequest">
        UPDATE DC_RESERVE_MASTER
        SET MOD_DT = NOW()
        <if test=" modId != null and modId != '' ">
            , MOD_ID = #{modId}
        </if>
        <if test=" reserveStatusCode != null and reserveStatusCode != '' ">
            , RESERVE_STATUS_CODE = #{reserveStatusCode}
        </if>
        <if test=" deliveryTypeCode != null and deliveryTypeCode != '' ">
            , DELIVERY_TYPE_CODE = #{deliveryTypeCode}
        </if>
        <if test=" rentStartDay != null and rentStartDay != '' ">
            , RENT_START_DAY = #{rentStartDay}
        </if>
        <if test=" rentStartTime != null and rentStartTime != '' ">
            , RENT_START_TIME = #{rentStartTime}
        </if>
        <if test=" rentEndDay != null and rentEndDay != '' ">
            , RENT_END_DAY = #{rentEndDay}
        </if>
        <if test=" rentEndTime != null and rentEndTime != '' ">
            , RENT_END_TIME = #{rentEndTime}
        </if>
        <if test=" periodDt != null and periodDt != '' ">
            , PERIOD_DT = #{periodDt}
        </if>
        <if test=" deliveryAddr != null and deliveryAddr != '' ">
            , DELIVERY_Addr = #{deliveryAddr}
        </if>
        <if test=" returnAddr != null and returnAddr != '' ">
            , RETURN_Addr = #{returnAddr}
        </if>
        <if test=" firstDriverName != null and firstDriverName != '' ">
            , FIRST_DRIVER_NAME = #{firstDriverName}
        </if>
        <if test=" firstDriverGender != null and firstDriverGender != '' ">
            , FIRST_DRIVER_GENDER = #{firstDriverGender}
        </if>
        <if test=" firstDriverContact != null and firstDriverContact != '' ">
            , FIRST_DRIVER_CONTACT = #{firstDriverContact}
        </if>
        <if test=" firstDriverBirthDay != null and firstDriverBirthDay != '' ">
            , FIRST_DRIVER_BIRTHDAY = #{firstDriverBirthDay}
        </if>
        <if test=" firstDriverLicenseCode != null and firstDriverLicenseCode != '' ">
            , FIRST_DRIVER_LICENSE_CODE = #{firstDriverLicenseCode}
        </if>
        <if test=" firstDriverLicenseNumber != null and firstDriverLicenseNumber != '' ">
            , FIRST_DRIVER_LICENSE_NUMBER = #{firstDriverLicenseNumber}
        </if>
        <if test=" firstDriverExpirationDate != null and firstDriverExpirationDate != '' ">
            , FIRST_DRIVER_EXPIRATION_DATE = #{firstDriverExpirationDate}
        </if>
        <if test=" firstDriverLicenseIsDate != null and firstDriverLicenseIsDate != '' ">
            , FIRST_DRIVER_LICENSE_IS_DATE = #{firstDriverLicenseIsDate}
        </if>
        <if test=" secondDriverName != null and secondDriverName != '' ">
            , SECOND_DRIVER_NAME = #{secondDriverName}
        </if>
        <if test=" secondDriverGender != null and secondDriverGender != '' ">
            , SECOND_DRIVER_GENDER = #{secondDriverGender}
        </if>
        <if test=" secondDriverContact != null and secondDriverContact != '' ">
            , SECOND_DRIVER_CONTACT = #{secondDriverContact}
        </if>
        <if test=" secondDriverBirthDay != null and secondDriverBirthDay != '' ">
            , SECOND_DRIVER_BIRTHDAY = #{secondDriverBirthDay}
        </if>
        <if test=" secondDriverLicenseCode != null and secondDriverLicenseCode != '' ">
            , SECOND_DRIVER_LICENSE_CODE = #{secondDriverLicenseCode}
        </if>
        <if test=" secondDriverLicenseNumber != null and secondDriverLicenseNumber != '' ">
            , SECOND_DRIVER_LICENSE_NUMBER = #{secondDriverLicenseNumber}
        </if>
        <if test=" secondDriverExpirationDate != null and secondDriverExpirationDate != '' ">
            , SECOND_DRIVER_EXPIRATION_DATE = #{secondDriverExpirationDate}
        </if>
        <if test=" secondDriverLicenseIsDate != null and secondDriverLicenseIsDate != '' ">
            , SECOND_DRIVER_LICENSE_IS_DATE = #{secondDriverLicenseIsDate}
        </if>
        <if test=" reserveUserName != null and reserveUserName != '' ">
            , RESERVE_USER_NAME = #{reserveUserName}
        </if>
        <if test=" reserveUserEmail != null and reserveUserEmail != '' ">
            , RESERVE_USER_EMAIL = #{reserveUserEmail}
        </if>
        <if test=" reserveUserContact1 != null and reserveUserContact1 != '' ">
            , RESERVE_USER_CONTACT1 = #{reserveUserContact1}
        </if>
        <if test=" reserveUserBirthday != null and reserveUserBirthday != '' ">
            , RESERVE_USER_BIRTHDAY = #{reserveUserBirthday}
        </if>
        <if test=" reserveUserGender != null and reserveUserGender != '' ">
            , RESERVE_USER_GENDER = #{reserveUserGender}
        </if>
        <if test=" rentFee != null and rentFee != '' ">
            , RENT_FEE = #{rentFee}
        </if>
        <if test=" insuranceFee != null and insuranceFee != '' ">
            , INSURANCE_FEE = #{insuranceFee}
        </if>
        <if test=" addFee != null and addFee != '' ">
            , ADD_FEE = #{addFee}
        </if>
        <if test=" refundFee != null and refundFee != '' ">
            , REFUND_FEE = #{refundFee}
        </if>
        <if test=" paymentTotalAmount != null and paymentTotalAmount != '' ">
            , PAYMENT_TOTAL_AMOUNT = #{paymentTotalAmount}
        </if>
        <if test=" deliveryFee != null and deliveryFee != '' ">
            , DELIVERY_FEE = #{deliveryFee}
        </if>
        <if test=" cancelFee != null and cancelFee != '' ">
            , CANCEL_FEE = #{cancelFee}
        </if>
        <if test=" discountFee != null and discountFee != '' ">
            , DISCOUNT_FEE = #{discountFee}
        </if>
        <if test=" insuranceCopayment != null and insuranceCopayment != '' ">
            , INSURANCE_COPAYMENT = #{insuranceCopayment}
        </if>
        <if test=" carDamageCover != null and carDamageCover != '' ">
            , CAR_DAMAGE_COVER = #{carDamageCover}
        </if>
        WHERE RM_IDX = #{rmIdx}

    </update>


    <insert id="insertReserveInfo" parameterType="reserveInfoDetailRequest">
   <![CDATA[

              INSERT INTO DC_RESERVE_MASTER (
              RM_IDX
              , RESERVE_TYPE_CODE
              , RESERVE_STATUS_CODE
              , LONGTERM_YN
              , UR_IDX
              , RESERVE_USER_NAME
              , RESERVE_USER_EMAIL
              , RESERVE_USER_CONTACT1
              , RESERVE_USER_BIRTHDAY
              , RESERVE_USER_GENDER
              , RENT_START_DAY
              , RENT_START_TIME
              , RENT_END_DAY
              , RENT_END_TIME
              , PERIOD_DT
              , DELIVERY_TYPE_CODE
              , DELIVERY_ADDR
              , RETURN_ADDR
              , CR_IDX
              , CARTYPE_CODE
              , RT_IDX
              , COMPANY_NAME
              , RESERVE_DATE
              , CAR_DEPOSIT
              , RENT_FEE
              , INSURANCE_FEE
              , DISCOUNT_FEE
              , DELIVERY_FEE
              , ADD_FEE
              , PAYMENT_TOTAL_AMOUNT
              , CANCEL_FEE
              , CANCEL_AMOUNT
              , CANCEL_REASON
              , REFUND_FEE
              , QU_IDX
              , RESERVE_CHANNEL
              , UL_IDX1
              , FIRST_DRIVER_NAME
              , FIRST_DRIVER_GENDER
              , FIRST_DRIVER_CONTACT
              , FIRST_DRIVER_BIRTHDAY
              , FIRST_DRIVER_LICENSE_CODE
              , FIRST_DRIVER_LICENSE_NUMBER
              , FIRST_DRIVER_EXPIRATION_DATE
              , FIRST_DRIVER_LICENSE_IS_DATE
              , UL_IDX2
              , SECOND_DRIVER_NAME
              , SECOND_DRIVER_GENDER
              , SECOND_DRIVER_CONTACT
              , SECOND_DRIVER_BIRTHDAY
              , SECOND_DRIVER_LICENSE_CODE
              , SECOND_DRIVER_LICENSE_NUMBER
              , SECOND_DRIVER_EXPIRATION_DATE
              , SECOND_DRIVER_LICENSE_IS_DATE
              , INSURANCE_COPAYMENT
              , CAR_DAMAGE_COVER
              , REG_ID
              , REG_DT
              , DEL_YN )
              VALUES(
               #{rmIdx}
              , #{reserveTypeCode}
              , #{reserveStatusCode}
              , #{longTermYn}
              , #{urIdx}
              , #{reserveUserName}
              , #{reserveUserEmail}
              , #{reserveUserContact1}
              , #{reserveUserBirthday}
              , #{reserveUserGender}
              , #{rentStartDay}
              , #{rentStartTime}
              , #{rentEndDay}
              , #{rentEndTime}
              , #{periodDt}
              , #{deliveryTypeCode}
              , #{deliveryAddr}
              , #{returnAddr}
              , #{crIdx}
              , #{carTypeCode}
              , #{rtIdx}
              , #{companyName}
              , NOW()
              , #{carDeposit}
              , #{rentFee}
              , #{insuranceFee}
              , #{discountFee}
              , #{deliveryFee}
              , #{addFee}
              , #{paymentTotalAmount}
              , '0'
              , '0'
              , ''
              , '0'
              , ''
              , #{reserveChannel}
              , #{ulIdx1}
              , #{firstDriverName}
              , #{firstDriverGender}
              , #{firstDriverContact}
              , #{firstDriverBirthDay}
              , #{firstDriverLicenseCode}
              , #{firstDriverLicenseNumber}
              , #{firstDriverExpirationDate}
              , #{firstDriverLicenseIsDate}
              , #{ulIdx2}
              , #{secondDriverName}
              , #{secondDriverGender}
              , #{secondDriverContact}
              , #{secondDriverBirthDay}
              , #{secondDriverLicenseCode}
              , #{secondDriverLicenseNumber}
              , #{secondDriverExpirationDate}
              , #{secondDriverLicenseIsDate}
              , #{insuranceCopayment}
              , #{carDamageCover}
              , #{regId}
              , NOW()
              , 'N' )

        ]]>
   </insert>


    <!-- 예약체크 -->
    <select id="reserveInfoCheck" parameterType="reserveInfoDetailRequest" resultType="reserveInfoDetailResponse">

      <![CDATA[

                 WITH T_RESVER AS (
    SELECT #{reserveUserBirthday}                                                  AS BIRTH
         , #{crIdx}                                                               AS T_CR_IDX
         , #{rentStartDay}                                                            AS T_START_RENT_DAY
         , #{rentStartTime}                                                                    AS T_START_RENT_TIME
         , #{rentEndDay}                                                            AS T_END_RENT_DAY
         , #{rentEndTime}                                                                    AS T_END_RENT_TIME
         , ROUND(TIMESTAMPDIFF(MONTH , STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                               STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'))) AS DM_CNT
         , #{rtIdx}                                                                AS T_RT_IDX
         , CASE
               WHEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y%m%d'), 'DY') = '금' AND '1000' < '1200' THEN '주중'
               WHEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y%m%d'), 'DY') = '일' AND '1000' > '1200' THEN '주중'
               ELSE '주말' END                                                         as T_SDY
         , CASE
               WHEN DATE_FORMAT(STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d'), 'DY') = '금' AND '1000' < '1200' THEN '주중'
               WHEN DATE_FORMAT(STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d'), 'DY') = '일' AND '1000' > '1200' THEN '주중'
               ELSE '주말' END                                                         as T_EDY
         , 'OF'                                                                      AS DELIVERY_FLAG
)
SELECT '예약'                                                                           AS FLAG,
       CASE WHEN COUNT(RM_IDX) > 0 THEN '선택하신 대여시간에 해당 회원님의 예약건이 존재합니다.' ELSE 'Y' END AS MSG
FROM DC_RESERVE_MASTER A,
     T_RESVER B
WHERE A.RESERVE_STATUS_CODE = 'RS'
  AND (
        DATE_FORMAT(STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                    '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'),
                                                             '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                    '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'),
                                                             '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
    )
  AND A.UR_IDX = #{urIdx}
  AND A.RM_IDX != #{rmIdx}
UNION ALL
SELECT '예약'                                                                          AS FLAG,
       CASE WHEN COUNT(RM_IDX) > 0 THEN '선택하신 대여시간에 해당 차량의 예약건이 존재합니다.' ELSE 'Y' END AS MSG
FROM DC_RESERVE_MASTER A,
     T_RESVER B
WHERE A.CR_IDX = B.T_CR_IDX
  AND A.RESERVE_STATUS_CODE = 'RS'
  AND (
        DATE_FORMAT(STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                    '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'),
                                                             '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                    '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'),
                                                             '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
        OR
        DATE_FORMAT(STR_TO_DATE(T_END_RENT_DAY, '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s') BETWEEN DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_START_RENT_DAY, ' ', T_START_RENT_TIME), '%Y-%m-%d %H:%i:%s'),
                '%Y-%m-%d %H:%i:%s') AND DATE_FORMAT(
                STR_TO_DATE(CONCAT(T_END_RENT_DAY, ' ', T_END_RENT_TIME), '%Y-%m-%d %H:%i:%s'), '%Y-%m-%d %H:%i:%s')
    )
  AND A.RM_IDX != #{rmIdx}
#                     UNION ALL
#                     SELECT '휴차일' AS FLAG,
#                            CASE WHEN SUM(S_SUSPEND) > 0 THEN '대여일이 휴차일이어서 예약이 불가합니다.'
#                                 WHEN SUM(E_SUSPEND) > 0 THEN '반납일이 휴차일이어서 예약이 불가합니다.'
#                            ELSE 'Y'
#                     END AS MSG
#                     FROM (
#                     SELECT
#                     CASE WHEN DATE_FORMAT(STR_TO_DATE(T_RESVER.T_START_RENT_DT, '%Y-%m-%d'), '%Y-%m-%d') BETWEEN SUSPEND_START_DT AND SUSPEND_END_DT THEN 1 ELSE 0 END AS S_SUSPEND
#                     ,CASE WHEN DATE_FORMAT(STR_TO_DATE(T_RESVER.T_END_RENT_DT, '%Y-%m-%d'), '%Y-%m-%d') BETWEEN SUSPEND_START_DT AND SUSPEND_END_DT THEN 1 ELSE 0 END AS E_SUSPEND
#                     FROM DC_CAR_INFO_SUSPEND, T_RESVER
#                     WHERE DC_CAR_INFO_SUSPEND.CR_IDX = T_RESVER.T_CR_IDX
#                     )
UNION ALL
SELECT '차량'    AS FLAG,
       CASE
           WHEN SUM(AGENT_LIMIT) > 0 THEN '대여차량의 연령 제한을 만족하지 않아 예약불가합니다.'
           WHEN SUM(DAILY_MONTHLY_YN) > 0 AND SUM(DM_CNT) = 0 THEN '일대여를 운영하고 있지않아 예약 불가합니다.'
           WHEN SUM(DAILY_MONTHLY_YN) > 0 AND SUM(DM_CNT) >= 1 THEN '월대여를 운영하고 있지않아 예약 불가합니다.'
           ELSE 'Y'
           END AS MSG
FROM (
         SELECT CASE
                    WHEN ABS(ROUND(TIMESTAMPDIFF(YEAR ,ROUND(NOW()), STR_TO_DATE(T_RESVER.BIRTH, '%Y-%m-%d')))) >=
                         IFNULL(DC_CAR_INFO.AGE_LIMIT, '21') THEN 0
                    ELSE 1 END AS AGENT_LIMIT
              , CASE
                    WHEN DM_CNT = 0 AND IFNULL(DAILY_YN, 'Y') = 'Y' THEN 0
                    WHEN DM_CNT >= 1 AND IFNULL(MONTHLY_YN, 'Y') = 'Y' THEN 0
                    ELSE 1 END AS DAILY_MONTHLY_YN
              , DM_CNT
         FROM DC_CAR_INFO,
              T_RESVER
         WHERE DC_CAR_INFO.CR_IDX = T_RESVER.T_CR_IDX
     ) X
UNION ALL
SELECT '휴무일'   AS FLAG,
       CASE
           WHEN SUM(S_HOLIDAYS) > 0 THEN '대여일이 회원사 휴무일이어서 예약이 불가합니다.'
           WHEN SUM(E_HOLIDAYS) > 0 THEN '반납일이 회원사 휴무일이어서 예약이 불가합니다.'
           ELSE 'Y'
           END AS MSG
FROM (
         SELECT CASE
                    WHEN DATE_FORMAT(STR_TO_DATE(T_RESVER.T_START_RENT_DT, '%Y-%m-%d'),
                                     '%Y-%m-%d') BETWEEN HOLIDAY_START_DT AND HOLIDAY_END_DT THEN 1
                    ELSE 0 END AS S_HOLIDAYS
              , CASE
                    WHEN DATE_FORMAT(STR_TO_DATE(T_RESVER.T_END_RENT_DT, '%Y-%m-%d'),
                                     '%Y-%m-%d') BETWEEN HOLIDAY_START_DT AND HOLIDAY_END_DT THEN 1
                    ELSE 0 END AS E_HOLIDAYS
         FROM DC_HOLIDAYS,
              T_RESVER
         WHERE RT_IDX = T_RESVER.T_RT_IDX
     )
UNION ALL
SELECT '회원사'   AS FLAG,
       CASE
           WHEN SUM(COMPYS) > 0 THEN '대여시간이 회원사 영업시간이 아니어서 예약이 불가합니다'
           WHEN SUM(COMPYE) > 0 THEN '반납시간이 회원사 영업시간이 아니어서 예약이 불가합니다.'
           WHEN SUM(DELIVERYS) > 0 THEN '대여시간이 회원사 배달시간이 아니어서 예약이 불가합니다.'
           WHEN SUM(DELIVERYE) > 0 THEN '반납시간이 회원사 배달시간이 아니어서 예약이 불가합니다.'
           WHEN SUM(DELIVERYABLE) > 0 THEN '대여시간이 회원사 배달시작시간이 아니어서 예약이 불가합니다.'
           ELSE 'Y'
           END AS MSG
FROM (
         SELECT CASE
                    WHEN T_SDY = '주중' THEN
                        -- 주중 영업시작일 체크
                        CASE
                            WHEN T_START_RENT_DAY
                                     BETWEEN (CONCAT(T_START_RENT_DT ,' ', IFNULL(WEEKDAY_OPEN_START, '0000')))
                                     AND CONCAT(T_START_RENT_DT ,' ', IFNULL(WEEKDAY_OPEN_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    WHEN T_SDY = '주말' THEN
                        -- 주말 영업시각일 체크
                        CASE
                            WHEN T_START_RENT_DAY
                                     BETWEEN (CONCAT(T_START_RENT_DT ,' ', IFNULL(WEEKEND_OPEN_START, '0000')))
                                     AND CONCAT(T_START_RENT_DT , ' ' ,IFNULL(WEEKEND_OPEN_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    END
                    AS COMPYS,
                CASE
                    WHEN T_EDY = '주중' THEN
                        -- 주중 영업종료일 체크
                        CASE
                            WHEN T_END_RENT_DAY
                                     BETWEEN (CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKDAY_OPEN_START, '0000')))
                                     AND CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKDAY_OPEN_END, '2350')
                                THEN 0
                            ELSE 1 END
                    WHEN T_EDY = '주말' THEN
                        -- 주말 영업종료일 체크
                        CASE
                            WHEN T_END_RENT_DAY
                                     BETWEEN (CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKEND_OPEN_START, '0000')))
                                     AND CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKEND_OPEN_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    END
                    AS COMPYE,
                CASE
                    WHEN T_SDY = '주중' THEN
                        -- 주중 영업시작일 체크
                        CASE
                            WHEN T_START_RENT_DAY
                                     BETWEEN (CONCAT(T_START_RENT_DT , ' ', IFNULL(WEEKDAY_DELIVERY_START, '0000')))
                                     AND CONCAT(T_START_RENT_DT ,' ', IFNULL(WEEKDAY_DELIVERY_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    WHEN T_SDY = '주말' THEN
                        -- 주말 영업시각일 체크
                        CASE
                            WHEN T_START_RENT_DAY
                                     BETWEEN (CONCAT(T_START_RENT_DT ,' ', IFNULL(WEEKDAY_DELIVERY_START, '0000')))
                                     AND COCAT(T_START_RENT_DT ,' ' , IFNULL(WEEKDAY_DELIVERY_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    END
                    AS DELIVERYS,
                CASE
                    WHEN T_EDY = '주중' THEN
                        -- 주중 영업종료일 체크
                        CASE
                            WHEN T_END_RENT_DAY
                                     BETWEEN (CONCAT(T_END_RENT_DT ,' ' , IFNULL(WEEKEND_DELIVERY_START, '0000')))
                                     AND CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKEND_DELIVERY_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    WHEN T_EDY = '주말' THEN
                        -- 주말 영업종료일 체크
                        CASE
                            WHEN T_END_RENT_DAY
                                     BETWEEN (CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKEND_DELIVERY_START, '0000')))
                                     AND CONCAT(T_END_RENT_DT ,' ', IFNULL(WEEKEND_DELIVERY_END, '2350'))
                                THEN 0
                            ELSE 1 END
                    END
                    AS DELIVERYE,
                CASE
                    WHEN T_SDY = '주중' AND DELIVERY_FLAG = 'DL' THEN
                        -- 주중 영업시작일 체크
                        CASE
                            WHEN ROUND((STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s') - NOW()) * 24) >=
                                 WEEKDAY_ABLE_DELIVERY_TIME
                                THEN 0
                            ELSE 1 END
                    WHEN T_SDY = '주말' AND DELIVERY_FLAG = 'DL' THEN
                        -- 주말 영업시각일 체크
                        CASE
                            WHEN ROUND((STR_TO_DATE(T_START_RENT_DAY, '%Y-%m-%d %H:%i:%s') - NOW()) * 24) >=
                                 WEEKEND_ABLE_DELIVERY_TIME
                                THEN 0
                            ELSE 1 END
                    ELSE 0
                    END
                    AS DELIVERYABLE
         FROM DC_RENT_COMPANY_TIME,
              T_RESVER
         WHERE RT_IDX = T_RESVER.T_RT_IDX
     )

        ]]>

   </select>

    <select id="selectUserInfo" parameterType="reserveInfoRequest" resultType="reserveInfoResponse">

      SELECT UR_IDX
      ,      IFNULL(USER_ID       , '' ) AS USER_ID
      ,      IFNULL(USER_BIRTHDAY , '' ) AS USER_BIRTHDAY
      ,      IFNULL(USER_CONTACT1 , '' ) AS USER_CONTACT1
      ,      IFNULL(USER_GENDER   , '' ) AS USER_GENDER
      ,      IFNULL(USER_NAME     , '' ) AS USER_NAME
      FROM   DC_USER_INFO
      WHERE  USER_ID = #{userId}

   </select>

    <select id="selectCompanyList" parameterType="reserveInfoRequest" resultType="DocahRentCompanyDto">

        SELECT RT_IDX
        ,      IFNULL(RT_P_IDX                     , '' ) AS RT_P_IDX
        ,      IFNULL(COMPANY_NAME                 , '' ) AS COMPANY_NAME
        ,      IFNULL(COMPANY_ZIPCODE              , '' ) AS COMPANY_ZIPCODE
        ,      IFNULL(COMPANY_ADDRESS              , '' ) AS COMPANY_ADDRESS
        ,      IFNULL(COMPANY_ADDRESS_DETAIL       , '' ) AS COMPANY_ADDRESS_DETAIL
        ,      IFNULL(LAT                          , '' ) AS LAT
        ,      IFNULL(LNG                          , '' ) AS LNG
        ,      IFNULL(ESTABLISHED_DATE             , '' ) AS ESTABLISHED_DATE
        ,      IFNULL(COMPANY_REGISTRATION_NUMBER   , '' ) AS COMPANY_REGISTRATION_NUMBER
        ,      IFNULL(COMPANY_REGISTRATION_IMG     , '' ) AS COMPANY_REGISTRATION_IMG
        ,      IFNULL(ACCOUNT_BANK                 , '' ) AS ACCOUNT_BANK
        ,      IFNULL(ACCOUNT_NUMBER               , '' ) AS ACCOUNT_NUMBER
        ,      IFNULL(ACCOUNT_HOLDER               , '' ) AS ACCOUNT_HOLDER
        ,      IFNULL(ACCOUNT_IMG_IDX              , '' ) AS ACCOUNT_IMG_IDX
        ,      IFNULL(LONGTERM_RENT_YN             , '' ) AS LONGTERM_RENT_YN
        ,      IFNULL(SHORTTERM_RENT_YN            , '' ) AS SHORTTERM_RENT_YN
        ,      IFNULL(ALLIANCE_STATUS              , '' ) AS ALLIANCE_STATUS
        ,      IFNULL(BRANCH_ABLE_YN               , '' ) AS BRANCH_ABLE_YN
        ,      IFNULL(CAR_COUNT                    , '' ) AS CAR_COUNT
        ,      IFNULL(ETC                          , '' ) AS ETC
        ,      IFNULL(REG_ID                       , '' ) AS REG_ID
        ,      IFNULL(REG_DT                       , '' ) AS REG_DT
        ,      IFNULL(MOD_ID                       , '' ) AS MOD_ID
        ,      IFNULL(MOD_DT                       , '' ) AS MOD_DT
        ,      IFNULL(DEL_YN                       , '' ) AS DEL_YN
        ,      IFNULL(COMPANY_CONTACT1             , '' ) AS COMPANY_CONTACT1
        ,      IFNULL(COMPANY_CONTACT2             , '' ) AS COMPANY_CONTACT2
        ,      IFNULL(ALARM_YN                     , '' ) AS ALARM_YN
        ,      IFNULL(COMPANY_REGISTRATION_NAME    , '' ) AS COMPANY_REGISTRATION_NAME
        ,      IFNULL(BRANCH_NAME                  , '' ) AS BRANCH_NAME
        ,      IFNULL(ACCESS_YN                    , '' ) AS ACCESS_YN
        FROM   DC_RENT_COMPANY
        <trim prefix="WHERE" prefixOverrides="AND|OR">
            <if test="rtIdx != null and rtIdx != ''">
                <![CDATA[ AND RT_IDX = #{rtIdx} ]]>
            </if>
            <if test="rtPIdx != null and rtPIdx != ''">
                <![CDATA[ AND RT_P_IDX = #{rtPIdx} ]]>
            </if>
        </trim>

        ORDER BY COMPANY_NAME
    </select>

    <select id="selectCompanyInfo" parameterType="reserveInfoRequest" resultType="DocahRentCompanyDto">

      SELECT T1.RT_IDX
      ,      IFNULL(T1.RT_P_IDX                     , '' ) AS RT_P_IDX
      ,      IFNULL(T1.COMPANY_NAME                 , '' ) AS COMPANY_NAME
      ,      IFNULL(T1.COMPANY_ZIPCODE              , '' ) AS COMPANY_ZIPCODE
      ,      IFNULL(T1.COMPANY_ADDRESS              , '' ) AS COMPANY_ADDRESS
      ,      IFNULL(T1.COMPANY_ADDRESS_DETAIL       , '' ) AS COMPANY_ADDRESS_DETAIL
      ,      IFNULL(T1.LAT                          , '' ) AS LAT
      ,      IFNULL(T1.LNG                          , '' ) AS LNG
      ,      IFNULL(T1.ESTABLISHED_DATE             , '' ) AS ESTABLISHED_DATE
      ,      IFNULL(T1.COMPANY_REGISTRATION_NUMBER   , '' ) AS COMPANY_REGISTRATION_NUMBER
      ,      IFNULL(T1.COMPANY_REGISTRATION_IMG     , '' ) AS COMPANY_REGISTRATION_IMG
      ,      IFNULL(T1.ACCOUNT_BANK                 , '' ) AS ACCOUNT_BANK
      ,      IFNULL(T1.ACCOUNT_NUMBER               , '' ) AS ACCOUNT_NUMBER
      ,      IFNULL(T1.ACCOUNT_HOLDER               , '' ) AS ACCOUNT_HOLDER
      ,      IFNULL(T1.ACCOUNT_IMG_IDX              , '' ) AS ACCOUNT_IMG_IDX
      ,      IFNULL(T1.LONGTERM_RENT_YN             , '' ) AS LONGTERM_RENT_YN
      ,      IFNULL(T1.SHORTTERM_RENT_YN            , '' ) AS SHORTTERM_RENT_YN
      ,      IFNULL(T1.ALLIANCE_STATUS              , '' ) AS ALLIANCE_STATUS
      ,      IFNULL(T1.BRANCH_ABLE_YN               , '' ) AS BRANCH_ABLE_YN
      ,      IFNULL(T1.CAR_COUNT                    , '' ) AS CAR_COUNT
      ,      IFNULL(T1.ETC                          , '' ) AS ETC
      ,      IFNULL(T1.REG_ID                       , '' ) AS REG_ID
      ,      IFNULL(T1.REG_DT                       , '' ) AS REG_DT
      ,      IFNULL(T1.MOD_ID                       , '' ) AS MOD_ID
      ,      IFNULL(T1.MOD_DT                       , '' ) AS MOD_DT
      ,      IFNULL(T1.DEL_YN                       , '' ) AS DEL_YN
      ,      IFNULL(T1.COMPANY_CONTACT1             , '' ) AS COMPANY_CONTACT1
      ,      IFNULL(T1.COMPANY_CONTACT2             , '' ) AS COMPANY_CONTACT2
      ,      IFNULL(T1.ALARM_YN                     , '' ) AS ALARM_YN
      ,      IFNULL(T1.COMPANY_REGISTRATION_NAME    , '' ) AS COMPANY_REGISTRATION_NAME
      ,      IFNULL(T1.BRANCH_NAME                  , '' ) AS BRANCH_NAME
      ,      IFNULL(T1.ACCESS_YN                    , '' ) AS ACCESS_YN
      ,      IFNULL(T2.STAFF_NAME               , '' ) AS STAFF_NAME
      ,      IFNULL(T2.STAFF_CONTACT1            , '' ) AS STAFF_CONTACT1
      ,      IFNULL(T2.OWNER_YN                     , '' ) AS OWNER_YN
      ,      IFNULL(T2.STAFF_TITLE               , '' ) AS STAFF_TITLE
      FROM   DC_RENT_COMPANY T1
      LEFT OUTER JOIN DC_RENT_COMPANY_STAFF T2
          ON T1.RT_IDX = T2.RT_IDX
          AND T2.OWNER_YN = 'Y'
      WHERE  T1.RT_IDX = #{rtIdx}
   </select>


    <select id="selectCompanyInfoAndCarInfo" parameterType="reserveInfoRequest" resultType="DocahCarDto">
        <![CDATA[
         SELECT T1.CR_IDX                                           /* 차량idx           */
         ,      T1.MD_IDX                                            /* 모델상세idx           */
         ,      T1.RT_IDX                                            /* 제휴사idx            */
         ,      IFNULL(T1.MODEL_NAME         , '' ) AS MODEL_NAME             /* 모델명                    */
         ,      IFNULL(T1.MODEL_DETAIL_NAME  , '' ) AS MODEL_DETAIL_NAME       /* 모델상세                  */
         ,      IFNULL(T1.FUEL_CODE          , '' ) AS FUEL_CODE             /* 연료구분code          */
         ,      IFNULL(T1.TRANSMISSION_CODE  , '' ) AS TRANSMISSION_CODE        /* 변속기구분code      */
         ,      IFNULL(T1.DRIVE_TYPE_CODE    , '' ) AS DRIVE_TYPE_CODE        /* 구동방식구분code       */
         ,      IFNULL(T1.CARTYPE_CODE       , '' ) AS CARTYPE_CODE           /* 차종code          */
         ,      IFNULL(T1.DRIVE_LICENSE_CODE , '' ) AS DRIVE_LICENSE_CODE       /* 면허구분code          */
         ,      IFNULL(T1.COLOR_NAME         , '' ) AS COLOR_NAME             /* 색상code             */
         ,      IFNULL(T1.DISPLACEMENT       , '' ) AS DISPLACEMENT          /* 배기량                    */
         ,      IFNULL(T1.YEAR               , '' ) AS YEAR                /* 연식                      */
         ,      IFNULL(T1.MILEAGE            , '' ) AS MILEAGE             /* 주행거리                  */
         ,      IFNULL(T1.MAXIMUM_PASSENGER  , '' ) AS MAXIMUM_PASSENGER       /* 승차인원                  */
         ,      IFNULL(T1.PY_IDX             , '' ) AS PY_IDX                /* 요금idx           */
         ,      IFNULL(T1.DAILY_STANDARD_PAY      , '0' ) AS DAILY_STANDARD_PAY          /* 단기요금                  */
         ,      IFNULL(T1.MONTHLY_STANDARD_PAY       , '0' ) AS MONTHLY_STANDARD_PAY         /* 장기요금                  */
         ,      IFNULL(T1.LONGTERM_DEPOSIT   , '0' ) AS LONGTERM_FEE      /* 장기대여보증금         */
         ,      IFNULL(T1.CAR_STATUS_CODE    , '' ) AS CAR_STATUS_CODE       /* 차량상태code       */
         ,      IFNULL(T1.RESERVE_ABLE_YN    , '' ) AS RESERVE_ABLE_YN       /* 차량예약가능여부code   */
         ,      IFNULL(T1.CAR_REG_DT         , '' ) AS CAR_REG_DT             /* 차량등록일                */
         ,      IFNULL(T1.CAR_NUMBER         , '' ) AS CAR_NUMBER            /* 차량번호                  */
         ,      IFNULL(T1.CAR_CHASSIS_NUMBER , '' ) AS CAR_CHASSIS_NUMBER       /* 차대번호                  */
         ,      IFNULL(T1.IMG_IDX            , '' ) AS IMG_IDX             /* 이미지idx          */
         ,      IFNULL(T1.CAR_DRIVE_LIMIT    , '' ) AS CAR_DRIVE_LIMIT       /* 주행거리제한           */
         ,      IFNULL(T1.AGE_LIMIT          , '' ) AS AGE_LIMIT             /* 대여연령제한           */
         ,      IFNULL(T1.GARAGE_ADDR        , '' ) AS GARAGE_ADDR         /* 차고지주소                */
         ,      IFNULL(T1.CAR_ETC            , '' ) AS CAR_ETC               /* 비고                      */
         ,      T1.REG_ID                                            /* 등록자                    */
         ,      T1.REG_DT                                            /* 등록일시                  */
         ,      T1.MOD_ID                                           /* 수정자                    */
         ,      T1.MOD_DT                                            /* 수정일시                  */
         ,      T1.DEL_YN                                            /* 차량삭제여부           */
         ,      IFNULL(T1.MANUFACTURER_CODE , 'CF' ) AS MANUFACTURER_CODE    /* 제조사code     */
         ,      IFNULL(T1.FUEL_CODE     , 'CR' ) AS FUEL_NAME            /* 연료구분명            */
         ,      IFNULL(T1.COLOR_NAME         , '' ) AS COLOR_NAME
         ,      T1.CI_IDX                        AS CI_IDX                     /*인덱스      */
         ,      IFNULL(T1.CAR_DAMAGE_COVER      ,  '0' ) AS CAR_DAMAGE_COVER        /*자차보상금액   */
         ,      IFNULL(T1.ONSELF_DAMAGE_COVER   ,  '0' ) AS ONSELF_DAMAGE_COVER     /*자손보상금액   */
         ,      IFNULL(T1.PERSONAL_COVER        ,  '0' ) AS PERSONAL_COVER          /*대인보상금액   */
         ,      IFNULL(T1.PROPERTY_DAMAGE_COVER ,  '0' ) AS PROPERTY_DAMAGE_COVER   /*대물보상금액   */
         ,      IFNULL(T1.AGE_LIMIT             ,  '' ) AS AGE_LIMIT                  /*연령제한      */
         ,      IFNULL(T1.DEL_YN                ,  '' ) AS DEL_YN                     /*삭제여부      */

         ,      IFNULL(T1.INSURANCE_COPAYMENT      ,  '' ) AS INSURANCE_COPAYMENT      /*보험료      */
         ,      IFNULL(T1.CAR_DAMAGE_COVER         ,  '' ) AS CAR_DAMAGE_COVER         /*면책금      */
         ,      IFNULL(T1.INSURANCE_COPAYMENT2      ,  '' ) AS INSURANCE_COPAYMENT2     /*보험료2      */
         ,      IFNULL(T1.CAR_DAMAGE_COVER2      ,  '' ) AS CAR_DAMAGE_COVER2        /*면책금2      */
         ,      IFNULL(T1.INSURANCE_COPAYMENT3      ,  '' ) AS INSURANCE_COPAYMENT3     /*보험료3      */
         ,      IFNULL(T1.CAR_DAMAGE_COVER3      ,  '' ) AS CAR_DAMAGE_COVER3        /*면책금3      */
         ,      IFNULL(T1.INSURANCE_COPAYMENT4      ,  '' ) AS INSURANCE_COPAYMENT4     /*보험료4      */
         ,      IFNULL(T1.CAR_DAMAGE_COVER4      ,  '' ) AS CAR_DAMAGE_COVER4        /*면책금4      */
         ,      IFNULL(CA.CAROPTION_LIST_VALUE, '') AS OPTION_CODE_VALUE /* 옵션정보*/
         FROM   DC_CAR_INFO T1
                           LEFT OUTER JOIN
                           (
                              SELECT
                                   X.CR_IDX, GROUP_CONCAT(Y.CODE_VALUE ORDER BY Y.CODE_VALUE DESC SEPARATOR ',') AS CAROPTION_LIST_VALUE
                              FROM DC_CAR_INFO_OPTION X
                              INNER JOIN DC_COMMON_CODE Y
                                  ON (X.OPTION_DETAIL_CODE LIKE Y.CODE )
                                  AND Y.RT_CODE = 'CR'
                              GROUP BY X.CR_IDX
                           ) CA ON T1.CR_IDX = CA.CR_IDX
         WHERE  T1.RT_IDX = #{rtIdx}
      ]]>
        <if test="rentStartDay != null and rentStartDay != '' and rentEndDay != null and rentEndDay != ''">
            AND T1.CR_IDX NOT IN (
            SELECT CR_IDX
            FROM DC_RESERVE_MASTER
            WHERE RESERVE_STATUS_CODE = 'RS'
            AND RM_IDX != #{rmIdx}
            AND (
            STR_TO_DATE(RENT_START_DAY||RENT_START_TIME, '%Y-%m-%d %H:%i:%s') BETWEEN STR_TO_DATE(${rentStartDay},
            '%Y-%m-%d %H:%i:%s') and STR_TO_DATE(${rentEndDay}, '%Y-%m-%d %H:%i:%s')
            or STR_TO_DATE(RENT_END_DAY||RENT_END_TIME, '%Y-%m-%d %H:%i:%s') BETWEEN STR_TO_DATE(${rentStartDay}, '%Y-%m-%d %H:%i:%s')
            and STR_TO_DATE(${rentEndDay}, '%Y-%m-%d %H:%i:%s')
            or STR_TO_DATE(${rentStartDay}, '%Y-%m-%d %H:%i:%s') BETWEEN STR_TO_DATE(RENT_START_DAY||RENT_START_TIME,
            '%Y-%m-%d %H:%i:%s') and STR_TO_DATE(RENT_END_DAY||RENT_END_TIME, '%Y-%m-%d %H:%i:%s')
            or STR_TO_DATE(${rentEndDay}, '%Y-%m-%d %H:%i:%s') BETWEEN STR_TO_DATE(RENT_START_DAY||RENT_START_TIME,
            '%Y-%m-%d %H:%i:%s') and STR_TO_DATE(RENT_END_DAY||RENT_END_TIME, '%Y-%m-%d %H:%i:%s')
            )
            )
        </if>
        <![CDATA[
         ORDER BY T1.MD_IDX
      ]]>

    </select>

    <select id="selectCarInfo" parameterType="reserveInfoRequest" resultType="DocahCarDto">

      <![CDATA[

                 SELECT T1.CR_IDX                  AS CR_IDX                                    /*  차량idx            */
                 ,      IFNULL(T1.MD_IDX             , '' ) AS MD_IDX                                  /*  모델idx              */
                 ,      IFNULL(T1.RT_IDX             , '' ) AS RT_IDX                                  /*  제휴사idx               */
                 ,      IFNULL(T1.MODEL_NAME         , '' ) AS MODEL_NAME                              /*  모델명                     */
                 ,      IFNULL(T1.MODEL_DETAIL_NAME  , '' ) AS MODEL_DETAIL_NAME                         /*  모델상세명                 */
                 ,      IFNULL(T1.FUEL_CODE          , '' ) AS FUEL_CODE                               /*  연료구분code            */
--                  ,      IFNULL(GET_COMMON_CODE_VALUE('CR',T1.FUEL_CODE) , '' )  AS FUEL_NAME   /* 연료구분명            */
                 ,      IFNULL(T1.TRANSMISSION_CODE  , '' ) AS TRANSMISSION_CODE                       /*  변속기구분code          */
                 ,      IFNULL(T1.DRIVE_TYPE_CODE    , '' ) AS DRIVE_TYPE_CODE                         /*  구동방식구분code        */
                 ,      IFNULL(T1.CARTYPE_CODE       , '' ) AS CARTYPE_CODE                            /*  차종code             */
                 ,      IFNULL(T1.DRIVE_LICENSE_CODE , '' ) AS DRIVE_LICENSE_CODE                      /*  면허구분code            */
                 ,      IFNULL(T1.MANUFACTURER_CODE  , '' ) AS MANUFACTURER_CODE                       /*  제조사code              */
                 ,      IFNULL(T1.COLOR_NAME         , '' ) AS COLOR_NAME                              /*  색상                      */
                 ,      IFNULL(T1.DISPLACEMENT       , '' ) AS DISPLACEMENT                            /*  배기량                     */
                 ,      IFNULL(T1.YEAR               , '' ) AS YEAR                                    /*  연식                       */
                 ,      IFNULL(T1.MILEAGE            , '' ) AS MILEAGE                                 /*  주행거리                   */
                 ,      IFNULL(T1.MAXIMUM_PASSENGER  , '' ) AS MAXIMUM_PASSENGER                       /*  승차인원                   */
                 ,      IFNULL(T1.PY_IDX             , '' ) AS PY_IDX                                  /*  요금idx              */
                 ,      IFNULL(T1.DAILY_STANDARD_PAY      , '' ) AS DAILY_STANDARD_PAY                           /*  단기요금                   */
                 ,      IFNULL(T1.DAILY_STANDARD_PAY       , '' ) AS DAILY_STANDARD_PAY                            /*  장기요금                   */
                 --,      IFNULL(T1.LONGTERM_DEPOSIT   , '' ) AS LONGTERM_DEPOSIT                        /*  장기대여보증금             */
                 ,      IFNULL(T1.CAR_STATUS_CODE    , '' ) AS CAR_STATUS_CODE                         /*  차량상태code            */
                 ,      IFNULL(T1.RESERVE_ABLE_YN    , '' ) AS RESERVE_ABLE_YN                         /*  차량예약가능여부code      */
                 ,      IFNULL(T1.CAR_REG_DT         , '' ) AS CAR_REG_DT                              /*  차량등록일                  */
                 ,      IFNULL(T1.CAR_NUMBER         , '' ) AS CAR_NUMBER                              /*  차량번호                   */
                 ,      IFNULL(T1.CAR_CHASSIS_NUMBER , '' ) AS CAR_CHASSIS_NUMBER                      /*  차대번호                   */
                 ,      IFNULL(T1.IMG_IDX            , '' ) AS IMG_IDX                                 /*  이미지idx               */
                 ,      IFNULL(T1.CAR_DRIVE_LIMIT    , '' ) AS CAR_DRIVE_LIMIT                         /*  주행거리제한               */
                 ,      IFNULL(T1.AGE_LIMIT          , '' ) AS AGE_LIMIT                               /*  대여연령제한               */
                 ,      IFNULL(T1.GARAGE_ADDR        , '' ) AS GARAGE_ADDR                           /*  차고지주소                 */
                 ,      IFNULL(T1.CAR_ETC            , '' ) AS CAR_ETC                                 /*  비고                       */
                 ,      IFNULL(T1.REG_ID             , '' ) AS REG_ID                            /*   등록자                     */
                 ,      IFNULL(DATE_FORMAT(T1.REG_DT  , '%Y.%m.%d')     , '' ) AS REG_DT               /*  등록일시                  */
                 ,      IFNULL(T1.MOD_ID             , '' ) AS MOD_ID                                  /*  수정자                     */
                 ,      IFNULL(T1.MOD_DT             , '' ) AS MOD_DT                                  /*  수정일시                   */
                 ,      IFNULL(T1.DEL_YN             , '' ) AS DEL_YN                                  /*  차량삭제여부              */
                 ,      IFNULL(T2.OPTION_CODE     , '' ) AS OPTION_CODE
                 ,      IFNULL(T2.OPTION_CODE_VALUE    , '' ) AS OPTION_CODE_VALUE
                 ,      IFNULL(T3.INSURANCE_FEE         ,  '0' ) AS INSURANCE_FEE           /*보혐요금      */
                 ,      IFNULL(T3.CAR_DAMAGE_COVER      ,  '0' ) AS CAR_DAMAGE_COVER        /*자차보상금액   */
                 ,      IFNULL(T3.ONSELF_DAMAGE_COVER   ,  '0' ) AS ONSELF_DAMAGE_COVER     /*자손보상금액   */
                 ,      IFNULL(T3.PERSONAL_COVER        ,  '0' ) AS PERSONAL_COVER          /*대인보상금액   */
                 ,      IFNULL(T3.PROPERTY_DAMAGE_COVER ,  '0' ) AS PROPERTY_DAMAGE_COVER   /*대물보상금액   */
                 ,      IFNULL(T3.AGE_LIMIT             ,  '' ) AS AGE_LIMIT               /*연령제한      */
                 ,      IFNULL(T3.DRIVE_CAREER_LIMIT    ,  '' ) AS DRIVE_CAREER_LIMIT      /*운전경력제한   */
                 ,      IFNULL(T3.INSURANCE_COPAYMENT   ,  '0' ) AS INSURANCE_COPAYMENT     /*고객부담금   */
                 FROM   DC_CAR_INFO T1
                 LEFT OUTER JOIN (
                        SELECT CR_IDX
                        ,      LISTAGG(OPTION_DETAIL_CODE , ',') WITHIN GROUP(ORDER BY CR_IDX) AS OPTION_CODE
--                         ,      LISTAGG(GET_COMMON_CODE_VALUE('CO',OPTION_DETAIL_CODE) , ',') WITHIN GROUP(ORDER BY CR_IDX) AS OPTION_CODE_VALUE
                        FROM   DC_CAR_INFO_OPTION
                        GROUP BY CR_IDX
                     ) T2 ON T1.CR_IDX = T2.CR_IDX
                 LEFT OUTER JOIN DC_CAR_INFO_INSURANCE T3 ON T1.CR_IDX = T3.CR_IDX
                 WHERE  T1.CR_IDX = #{crIdx}

        ]]>

   </select>


    <select id="selectCarInsuranceInfo" parameterType="reserveInfoRequest" resultType="DocahCarDto">

      <![CDATA[


                 SELECT CI_IDX
                 ,      IFNULL(CR_IDX                   , '' ) AS CR_IDX
                 ,      IFNULL(INSURANCE_FEE            , '' ) AS INSURANCE_FEE
                 ,      IFNULL(CAR_DAMAGE_COVER         , '' ) AS CAR_DAMAGE_COVER
                 ,      IFNULL(ONSELF_DAMAGE_COVER      , '' ) AS ONSELF_DAMAGE_COVER
                 ,      IFNULL(PERSONAL_COVER           , '' ) AS PERSONAL_COVER
                 ,      IFNULL(PROPERTY_DAMAGE_COVER   , '' ) AS PROPERTY_DAMAGE_COVER
                 ,      IFNULL(INSURANCE_COPAYMENT      , '' ) AS INSURANCE_COPAYMENT
                 ,      IFNULL(AGE_LIMIT                , '' ) AS AGE_LIMIT
                 ,      IFNULL(DRIVE_CAREER_LIMIT       , '' ) AS DRIVE_CAREER_LIMIT
                 ,      IFNULL(REG_ID                   , '' ) AS REG_ID
                 ,      IFNULL(REG_DT                   , '' ) AS REG_DT
                 ,      IFNULL(MOD_ID                   , '' ) AS MOD_ID
                 ,      IFNULL(MOD_DT                   , '' ) AS MOD_DT
                 ,      IFNULL(DEL_YN                   , '' ) AS DEL_YN
                 ,      IFNULL(RT_IDX                   , '' ) AS RT_IDX
                 ,      IFNULL(CAR_DAMAGE_COVER2        , '' ) AS CAR_DAMAGE_COVER2
                 ,      IFNULL(INSURANCE_COPAYMENT2     , '' ) AS INSURANCE_COPAYMENT2
                 ,      IFNULL(CAR_DAMAGE_COVER3        , '' ) AS CAR_DAMAGE_COVER3
                 ,      IFNULL(INSURANCE_COPAYMENT3     , '' ) AS INSURANCE_COPAYMENT3
                 ,      IFNULL(CAR_DAMAGE_COVER4        , '' ) AS CAR_DAMAGE_COVER4
                 ,      IFNULL(INSURANCE_COPAYMENT4     , '' ) AS INSURANCE_COPAYMENT4
                 ,      IFNULL(CAR_DAMAGE1_YN           , '' ) AS CAR_DAMAGE1_YN
                 ,      IFNULL(CAR_DAMAGE2_YN           , '' ) AS CAR_DAMAGE2_YN
                 ,      IFNULL(CAR_DAMAGE3_YN           , '' ) AS CAR_DAMAGE3_YN
                 ,      IFNULL(CAR_DAMAGE4_YN           , '' ) AS CAR_DAMAGE4_YN
                 ,      IFNULL(CI_ETC                   , '' ) AS CI_ETC
                 FROM   DC_CAR_INFO_INSURANCE
                 WHERE  CR_IDX = #{crIdx}


        ]]>

   </select>

</mapper>





